# CodeIgniter 4 Development & Deployment Rules

This document outlines the mandatory rules and workflow for developing and deploying this CodeIgniter 4 application.

---

## Part 1: Architectural & Naming Conventions

All code must adhere strictly to the CodeIgniter 4 architecture and the following conventions.

### 1.1. File Naming Conventions

- **Controllers:** `PascalCaseController.php` (e.g., `UserController.php`). Exception: `BaseController.php`.
- **Models:** `PascalCaseModel.php` (e.g., `UserModel.php`).
- **Entities:** `PascalCase.php` (e.g., `User.php`).
- **Libraries/Services:** `PascalCaseService.php` (e.g., `PaymentService.php`).
- **Views:** Grouped in a `lowercase` subdirectory named after the controller. File names must be `snake_case.php`.
- **Migrations & Seeds:** Use the timestamp-prefixed, `PascalCase` format generated by `php spark`.

### 1.2. Component-Specific Rules

- **Controllers (`app/Controllers/`):**
    - Keep controllers lean, focused on request/response flow.
    - Delegate all business logic to Models or Libraries/Services.

- **Models (`app/Models/`):**
    - Handle all database interactions (Models, Query Builder, or Entities).
    - Never place direct database queries in Controllers.
    - Import models via `use` and instantiate with their short class name (e.g., `new UserModel()`).

- **Views (`app/Views/`):**
    - Handle presentation with minimal PHP.
    - Escape all dynamic data with `esc()` to prevent XSS.
    - Use View Layouts for page structure and View Cells for reusable components.
    - Do not wrap entire view files in `<![CDATA[...]]>` tags.

- **Routing (`app/Config/Routes.php`):**
    - All routes must be named using the `['as' => 'route.name']` option.
    - Use `url_to('route.name')` in Views to generate URLs.
    - Use `redirect()->to(url_to('route.name'))` in Controllers for server-side redirects.

- **Database (`app/Database/`):**
    - Manage schema changes with Migrations and initial data with Seeders.
    - For tables with timestamps, include `created_at` and `updated_at` fields and set `$useTimestamps = true` in the corresponding model.

- **Libraries/Services (`app/Libraries/`, `app/Config/Services.php`):**
    - House reusable application logic as classes.
    - Manage them as Services for scalability and testability.

### 1.3. Dynamic Responses & Flash Messaging

1.  **Controller Actions:**
    - Action methods (e.g., `create()`, `generate()`) must process the request, then store all response data (status messages, results) in the session via `session()->setFlashdata()` or a redirect's `with()` method.
    - Conclude by redirecting, typically using `return redirect()->back()->withInput()`. **Direct JSON responses from these actions are forbidden.**

2.  **View Display:**
    - The controller method displaying the view (e.g., `index()`) must retrieve all flash data from the session and pass it to the view.
    - Status messages (`success`, `error`, etc.) must be rendered exclusively through the `app/Views/partials/flash_messages.php` partial.
    - The primary `result` of an action is rendered in the main content area of the specific view.

3.  **Standardized Flashdata Keys:**
    - `success`, `error`, `warning`, `info`, `errors`, `result`.

---

## Part 2: Coding, Security, & Performance

### 2.1. Code Standards
- Adhere to the **PSR-12** coding standard.
- Use modern PHP features: strict types, typed properties, and return type declarations.
- Prioritize built-in CodeIgniter functions before writing custom code.
- Use CodeIgniterâ€™s `API Response Trait` for standardizing API responses.

### 2.2. Security Mandates
- **CSRF Protection:** Enable globally.
- **Content Security Policy (CSP):** Enable and configure.
- **Database:** Use the Query Builder or prepared statements for all queries. Raw queries are forbidden.
- **Validation:** Validate all user input (`$GET`, `$POST`, etc.) with the Validation library.
- **Output Escaping:** Escape all data rendered in HTML with `esc()`.
- **HTTPS:** Set `cookie.secure` and `cookie.httponly` to `true`. Store session data in a database for production.
- **Throttler:** Enable on authentication and other sensitive routes to prevent brute-force attacks.

### 2.3. Performance Optimization
- Disable auto-routing (`$autoRoute = false`) if all routes are explicitly defined.
- Enable and configure a production-ready caching driver (Redis or Memcached).
- Use `php spark optimize` in the deployment script.
- Optimize database queries by selecting only necessary columns and avoiding `findAll()` where possible.

### 2.4. Error Handling & Logging
- Disable detailed error reporting to the browser in production.
- Enable exception logging by setting `$log = true` in `app/Config/Exceptions.php`.
- Set the production logging threshold to an appropriate level (e.g., 4 for errors) in `app/Config/Logger.php`.
- When a feature requires a specific PHP extension (e.g., `bcmath`), check if it's loaded with `extension_loaded()` and log an error if it's missing.

---

## Part 3: Deployment & Environment

### 3.1. Environment Configuration (`.env`)
- Set `CI_ENVIRONMENT` to `production`.
- The production `.env` file must not be committed to version control. Use a template (`env`).
- Define environment-specific variables (credentials, keys) in `.env` and access via `env()`.
- Set `app.baseURL` with a trailing slash.

### 3.2. Web Server & Filesystem
- The web server's document root must point to the project's `/public` directory.
- `app`, `system`, and `writable` directories must be outside the document root.
- Grant write permissions on the `writable` directory to the web server user.
- Remove development-only files (`tests/`, `phpunit.xml.dist`, `spark`) from the production server.

### 3.3. Dependency Management
- Before deployment, run `composer install --no-dev --optimize-autoloader`.

---

## Part 4: AI Agent Workflow

1.  **Analyze Request:** Deconstruct requests into logical, sequential file modifications that align with these rules.
2.  **Propose Changes:** State intended modifications and affected files before implementation.
3.  **Adhere to Rules:** All modifications must respect the principles outlined in this document.
4.  **File Generation:** Use `php spark make:*` commands to generate boilerplate files. Manual creation is forbidden. Do not alter generated boilerplate structure.
5.  **File Modification:** Specify the full file path from the project root and provide the complete, updated file content.
6.  **Final Confirmation:** Confirm all changes have been applied in accordance with these rules before concluding.


 URL References

   Application Structure: https://codeigniter.com/userguide/concepts/structure.html
   API Responses: https://codeigniter.com/userguide/outgoing/apiresponses.html
   Caching: https://codeigniter.com/userguide/libraries/caching.html
   CLI Generators: https://codeigniter.com/userguide/cli/cligenerators.html
   Configuration: https://codeigniter.com/userguide/general/configuration.html
   Content Security Policy (CSP): https://codeigniter.com/userguide/outgoing/csp.html
   Controllers: https://codeigniter.com/userguide/incoming/controllers.html
   Deployment: https://codeigniter.com/userguide/installation/deployment.html
   Entities: https://codeigniter.com/userguide/models/entities.html
   Environments: https://codeigniter.com/userguide/general/environments.html
   Error Handling: https://codeigniter.com/userguide/general/errors.html
   Filters: https://codeigniter.com/userguide/incoming/filters.html
   Helpers: https://codeigniter.com/userguide/general/helpers.html
   Localization: https://codeigniter.com/userguide/outgoing/localization.html
   Logging: https://codeigniter.com/userguide/general/logging.html
   Migrations: https://codeigniter.com/userguide/dbmgmt/migration.html
   Models: https://codeigniter.com/userguide/models/model.html
   Modules: https://codeigniter.com/userguide/general/modules.html
   PSR Standards: https://codeigniter.com/userguide/intro/psr.html
   Query Builder: https://codeigniter.com/userguide/database/querybuilder.html
   Routing: https://codeigniter.com/userguide/incoming/routing.html
   Security: https://codeigniter.com/userguide/libraries/security.html
   Seeding: https://codeigniter.com/userguide/dbmgmt/seeding.html
   Services: https://codeigniter.com/userguide/concepts/services.html
   Sessions: https://codeigniter.com/userguide/libraries/sessions.html
   Testing: https://codeigniter.com/userguide/testing/index.html
   Throttler: https://codeigniter.com/userguide/libraries/throttler.html
   Validation: https://codeigniter.com/userguide/libraries/validation.html
   View Cells: https://codeigniter.com/userguide/outgoing/viewcells.html
   View Layouts: https://codeigniter.com/userguide/outgoing/viewlayouts.html
